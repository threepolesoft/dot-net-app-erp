@using System.ComponentModel.DataAnnotations;
@using Erp.Services
@using Erp.Services.TransferService
@using AppBO.Models
@using System.Security.Claims
@using AppBO.Utility
@using static AppBO.Utility.Utility
@inherits FeedbackComponent<ApplicationUserModel, string>
@inject UserTransferService tUser;
@inject IMessageService _message
@inject RestService rest;
@inject RoleTransferService tRole;

<Form @ref="form"
Model="@model"
LabelColSpan="8"
WrapperColSpan="16"
ValidateOnChange="@true"
OnFinish="OnFinish"
OnFinishFailed="OnFinishFailed"
RequiredMark="FormRequiredMark.Required">


    <FormItem Label="Full Name">
        <Input @bind-Value="@context.FullName" Placeholder="Full Name" />
    </FormItem>

    <FormItem Label="Role">
        <Select @bind-Value="@context.RoleId"
        DefaultValue="@context.RoleId"
        Style="width: 120px;"
        TItemValue="long"
        Placeholder="Select"
        TItem="string">
            <SelectOptions>
                @foreach (var item in tRole.Roles)
                {
                    <SelectOption Value="@(item.RoleId)" Label="@item.RoleTitle" />
                }

            </SelectOptions>
        </Select>
    </FormItem>

    <FormItem Label="User Name">
        <Input @bind-Value="@context.UserName" Placeholder="User Name" />
    </FormItem>

    <FormItem Label="E-mail">
        <Input @bind-Value="@context.Email" Placeholder="E-mail" />
    </FormItem>

    <FormItem Label="Phone">
        <Input @bind-Value="@context.Phone" Placeholder="Phone" />
    </FormItem>


    <FormItem Label="Active">
        <Checkbox Value="@context.IsActive"
        OnChange="(val)=>ChangeActive(val)" />
    </FormItem>

</Form>


@code {

    private Form<ApplicationUserModel> form;

    string config;

    string value;

    public ApplicationUserModel model;

    public ClaimsPrincipal User;

    [CascadingParameter]
    protected Task<AuthenticationState> AuthStat { get; set; }
    public string Token { get; set; }

    protected async override Task OnInitializedAsync()
    {
        model = new ApplicationUserModel
            {
                ApplicationUserId = this.Options.ApplicationUserId,
                FullName = this.Options.FullName,
                RoleId = this.Options.RoleId,
                UserName = this.Options.UserName,
                Email = this.Options.Email,
                Phone = this.Options.Phone,
                IsActive = this.Options.IsActive
            };

        User = (await AuthStat)?.User;
        Token = User.FindFirst("Token")?.Value;

        if (!tRole.Roles.Any())
        {
            List<RoleModel> result = await rest.GET($"/api/role/all", Token).ToModel<List<RoleModel>>();
            tRole.Roles = result;
        }

    }


    public override async Task OnFeedbackOkAsync(ModalClosingEventArgs args)
    {
        if (FeedbackRef is ConfirmRef confirmRef)
        {
            await confirmRef.UpdateConfigAsync();
        }
        else if (FeedbackRef is ModalRef modalRef)
        {
            if (form.Validate() == true)
            {
                form.Submit();
                modalRef.Config.ConfirmLoading = true;
                await modalRef.UpdateConfigAsync();
            }

        }

        await Task.Delay(1000);
        // only the input's value equals the initialized value, the OK button will close the confirm dialog box
        if (value != config)
            args.Cancel = true;
        else
            // method 1(not recommended): await (FeedbackRef as ConfirmRef<string>)!.OkAsync(value);
            // method 2: await (FeedbackRef as IOkCancelRef<string>)!.OkAsync(value);
            //await base.OkCancelRefWithResult!.OnOk(value);

            await base.OnFeedbackOkAsync(args);
    }

    public void ChangeActive(bool val)
    {
        model.IsActive = val;
    }

    private async void OnFinish(EditContext editContext)
    {
        string key = $"updatable-{DateTime.Now.Ticks}";
        var config = new MessageConfig()
            {
                Content = "Saving...",
                Key = key,
                Duration = 0
            };
        _ = _message.Loading(config);

        ApplicationUserModel model_ = (ApplicationUserModel)editContext.Model;
        model_.Password = string.Empty;

        try
        {

            ApiResponse result = await rest.POST($"/api/auth/user-save", model_, Token);

            if (FeedbackRef is ModalRef modalRef)
            {
                modalRef.Config.ConfirmLoading = false;
                await modalRef.UpdateConfigAsync();
            }

            if (result.Status == true)
            {
                ApplicationUserModel settingModel = result.Data.ToObject<ApplicationUserModel>();

                if (model_.ApplicationUserId == 0)
                {
                    tUser.Users.Add(settingModel);
                }
                else
                {
                    foreach (var item in tUser.Users)
                    {
                        if (item.ApplicationUserId == model_.ApplicationUserId)
                        {
                            item.FullName = model_.FullName;
                            item.RoleId = model_.RoleId;
                            item.UserName = model_.UserName;
                            item.Email = model_.Email;
                            item.Phone = model_.Phone;
                            item.IsActive = model_.IsActive;
                            break;
                        }
                    }
                }
                tUser.NotifyStateChanged();
                config.Content = "Done";
                config.Duration = 2;
                _ = _message.Success(config);

            }
            else
            {
                config.Content = result.Message;
                config.Duration = 2;
                _ = _message.Error(config);
            }
        }
        catch (Exception ex)
        {
            _ = _message.Error(ex.Message);
        }
    }

    private void OnFinishFailed(EditContext editContext)
    {

    }

    /// <summary>
    /// If you want <b>Dispose</b> to take effect every time it is closed in Modal, which created by ModalService,
    /// set <b>ModalOptions.DestroyOnClose = true</b>
    /// </summary>
    /// <param name="disposing"></param>
    protected override void Dispose(bool disposing)
    {
        Console.WriteLine("Dispose");
        base.Dispose(disposing);
    }
}